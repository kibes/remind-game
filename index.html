<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REMIND</title>
    <style>
        /* –°–±—Ä–æ—Å —Å—Ç–∏–ª–µ–π –∏ –±–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ–Ω –∏ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ */
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #db4e4e;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 10px;
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–≥—Ä—ã */
        .game-container {
            width: 100%;
            max-width: 100%;
            background: white;
            border-radius: 45px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            height: calc(100vh - 20px);
            margin: auto;
            position: relative;
            overflow: hidden;
            max-width: 800px;
            max-height: 800px;
        }

        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .header { text-align: center; margin-bottom: 10px; flex-shrink: 0; }
        h1 { font-size: 32px; color: #db4e4e; font-weight: 300; letter-spacing: 1px; }
        .stats { display: flex; justify-content: center; gap: 25px; margin-top: 10px; }
        .stat-label { font-size: 12px; color: #db4e4e; text-transform: uppercase; }
        .stat-value { font-size: 24px; font-weight: bold; color: #333; transition: 0.3s; }
        .stat-value.updating { transform: scale(1.2); color: #db4e4e; }

        /* –ò–≥—Ä–æ–≤–∞—è –æ–±–ª–∞—Å—Ç—å */
        .game-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 1;
            visibility: visible;
            transition: opacity 0.4s ease 0s, visibility 0.4s ease 0s;
            min-height: 0;
        }
        .game-content.hidden { 
            opacity: 0; 
            pointer-events: none; 
            visibility: hidden; 
            transition: opacity 0.4s ease 0s, visibility 0.4s ease 0s; 
        }

        /* –û–±–ª–∞—Å—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ */
        .character-display {
            width: 100%;
            max-width: 380px;
            flex: 1;
            min-height: 200px;
            max-height: 480px;
            position: relative;
            border: 2px solid #db4e4e;
            border-radius: 30px;
            background: #fff;
            overflow: hidden;
            margin-top: 5px;
        }

        @media (max-height: 500px) {
            .character-display {
                max-height: 250px;
            }
        }

        .character-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-size: contain; background-repeat: no-repeat; background-position: center bottom;
        }

        /* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–µ–∫—Ü–∏—è */
        .info-section {
            height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            width: 100%;
            flex-shrink: 0;
        }
        .instruction { 
            font-size: 22px;
            color: #db4e4e; 
            font-weight: bold; 
            opacity: 0; 
            transform: translateY(10px);
            transition: 0.4s all; 
            min-height: 26px;
        }
        .instruction.show { opacity: 1; transform: translateY(0); }
        
        /* –¢–∞–π–º–µ—Ä */
        .timer { 
            font-size: 100px;
            font-weight: bold; 
            color: #db4e4e; 
            opacity: 0; 
            transition: opacity 0.3s ease;
            position: absolute;
            bottom: 20px;
            z-index: 5;
        }
        .timer.show { opacity: 1; }

        /* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–∫–Ω–æ–ø–∫–∏) */
        .controls-container {
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            z-index: 10;
            flex-shrink: 0;
            margin-top: auto;
        }
        .btn {
            background: #db4e4e;
            color: white;
            border: none;
            padding: 18px 35px;
            font-size: 17px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
            margin-bottom: 20px;
            opacity: 1;
            transform: scale(1);
            width: auto;
            white-space: nowrap;
        }
        
        .btn:hover { background: #c93c3c; transform: translateY(-2px) scale(1); }
        .btn:active { transform: translateY(0) scale(1); }
        .btn.hidden { 
            display: none; 
            opacity: 0;
            transform: scale(0.8);
        }
        .btn.show { 
            display: block; 
            animation: buttonAppear 0.2s ease forwards;
        }
        
        @keyframes buttonAppear {
            0% { opacity: 0; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* –≠–∫—Ä–∞–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ */
        .result-screen {
            position: absolute;
            top: 120px;
            left: 0; 
            right: 0; 
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease 0s, visibility 0.4s ease 0s;
            padding: 0 10px 10px 10px;
            justify-content: flex-start;
            overflow-y: auto;
            max-height: calc(100% - 120px);
        }
        .result-screen.show { 
            opacity: 1; 
            visibility: visible; 
            z-index: 20; 
        }

        .comparison-container {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
        }
        
        .result-character {
            width: 100%;
            max-width: 500px;
            min-width: 300px;
            flex: 1;
            min-height: 430px;
            max-height: 480px;
            position: relative;
            border: 2px solid #db4e4e;
            border-radius: 30px;
            background: #fff;
            margin-top: 5px;
        }

        @media (max-width: 700px) {
            .comparison-container {
                flex-direction: column;
                align-items: center;
            }
            
            .result-character {
                min-height: 170px;
                max-height: 480px;
            }
        }

        .result-percent {
            font-size: 52px;
            font-weight: bold;
            color: #db4e4e;
            margin-bottom: 10px;
        }
        
        .result-text { 
            font-size: 20px;
            font-weight: bold; 
            color: #db4e4e; 
            margin-bottom: 25px;
            text-align: center;
        }
        
        .comparison-label { 
            text-transform: lowercase; 
            font-size: 14px; 
            color: #db4e4e; 
            text-align: center; 
            margin-top: 5px; 
        }
        
        .result-screen .controls-container {
            margin-top: 15px;
            padding-bottom: 10px;
            flex-shrink: 0;
        }
        
        @media (max-height: 700px) {
            .result-screen {
                overflow-y: auto;
            }
            
            .result-screen::-webkit-scrollbar {
                width: 4px;
            }
            
            .result-screen::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 10px;
            }
            
            .result-screen::-webkit-scrollbar-thumb {
                background: #db4e4e;
                border-radius: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <h1>REMIND</h1>
            <div class="stats">
                <div class="stat">
                    <div class="stat-label">–ò–≥—Ä–∞</div>
                    <div class="stat-value" id="round">1</div>
                </div>
                <div class="stat">
                    <div class="stat-label">–ú–∞–∫—Å. —Å–µ—Ä–∏—è</div>
                    <div class="stat-value" id="max-streak">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">–°–µ—Ä–∏—è –ø–æ–±–µ–¥</div>
                    <div class="stat-value" id="streak">0</div>
                </div>
            </div>
        </div>

        <!-- –ò–≥—Ä–æ–≤–∞—è –æ–±–ª–∞—Å—Ç—å -->
        <div class="game-content" id="game-area">
            <div class="character-display" id="character-display"></div>
            <div class="info-section">
                <div class="instruction" id="instruction">–ù–∞—á–Ω—ë–º?</div>
                <div class="timer" id="timer"></div>
            </div>
            <div class="controls-container">
                <button class="btn" id="start-btn">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
                <button class="btn hidden" id="select-btn">–í—ã–±—Ä–∞—Ç—å</button>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
        <div class="result-screen" id="result-screen">
            <div class="comparison-container">
                <div class="comparison-item">
                    <div class="result-character" id="result-target"></div>
                    <div class="comparison-label">–æ–∂–∏–¥–∞–Ω–∏–µ</div>
                </div>
                <div class="comparison-item">
                    <div class="result-character" id="result-player"></div>
                    <div class="comparison-label">—Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å</div>
                </div>
            </div>
            <div class="result-percent" id="result-percent">0%</div>
            <div class="result-text" id="result-text" style="margin-top:0"></div>
            <div class="controls-container" style="margin-top: auto; padding-bottom: 10px;">
                <button class="btn" id="result-again-btn">–ï—â—ë —Ä–∞–∑</button>
            </div>
        </div>
    </div>

    <script>
        // –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—ä–µ–∫—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
        const state = {
            round: 1,
            maxStreak: 0,
            streak: 0,
            target: {},
            selection: {},
            parts: ['skin', 'head', 'body', 'accessory'],
            partCounts: { skin: 4, head: 7, body: 8, accessory: 7 },
            loaded: {},
            order: {},
            interval: null,
            idleInterval: null,
            currentPart: 0,
            canSelect: true,
            idleCharacter: {},
            lastResult: null,
            isBusy: false,
            isTimerActive: false,
            gamePhase: 'idle',
            fastCycle: null,
            startBtnLock: false,
            resetBtnLock: false
        };

        // –°—Å—ã–ª–∫–∏ –Ω–∞ DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const elements = {
            round: document.getElementById('round'),
            maxStreak: document.getElementById('max-streak'),
            streak: document.getElementById('streak'),
            timer: document.getElementById('timer'),
            instruction: document.getElementById('instruction'),
            characterDisplay: document.getElementById('character-display'),
            startBtn: document.getElementById('start-btn'),
            selectBtn: document.getElementById('select-btn'),
            resultAgainBtn: document.getElementById('result-again-btn'),
            gameArea: document.getElementById('game-area'),
            resultScreen: document.getElementById('result-screen'),
            resultPercent: document.getElementById('result-percent'),
            resultText: document.getElementById('result-text'),
            resultTarget: document.getElementById('result-target'),
            resultPlayer: document.getElementById('result-player')
        };

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–∞–Ω–¥–æ–º–Ω–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        function createRandomOrder() {
            state.order = {};
            state.parts.forEach(type => {
                const indices = Array.from({length: state.partCounts[type]}, (_, i) => i);
                for (let i = indices.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [indices[i], indices[j]] = [indices[j], indices[i]];
                }
                state.order[type] = indices;
            });
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –ø–æ –∏–Ω–¥–µ–∫—Å—É –≤ —Ä–∞–Ω–¥–æ–º–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
        function getRandomOrderItem(type, index) {
            const realIndex = state.order[type][index % state.order[type].length];
            return state.loaded[type][realIndex];
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —á–∞—Å—Ç–µ–π –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
        async function loadImages() {
            const folders = { skin: 'skins/', head: 'heads/', body: 'bodies/', accessory: 'accessories/' };
            for (const type of state.parts) {
                state.loaded[type] = [];
                for (let i = 1; i <= state.partCounts[type]; i++) {
                    const img = new Image();
                    img.src = `${folders[type]}${i}.png`;
                    await new Promise(r => { 
                        img.onload = r; 
                        img.onerror = () => { r(); };
                    });
                    state.loaded[type].push({ id: i, img: img });
                }
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
        function render(container, data) {
            container.innerHTML = '';
            state.parts.forEach(p => {
                if (data[p]) {
                    const div = document.createElement('div');
                    div.className = 'character-layer';
                    div.style.backgroundImage = `url('${data[p].img.src}')`;
                    container.appendChild(div);
                }
            });
        }

        // –ó–∞–ø—É—Å–∫ –∞–Ω–∏–º–∞—Ü–∏–∏ –≤ —Ä–µ–∂–∏–º–µ –æ–∂–∏–¥–∞–Ω–∏—è
        function startIdle() {
            state.gamePhase = 'idle';
            state.startBtnLock = false;
            state.resetBtnLock = false;
            createRandomOrder();
            
            let instructionText;
            if (state.lastResult === null) {
                instructionText = "–ù–∞—á–Ω—ë–º?";
            } else if (state.lastResult === 'win') {
                instructionText = "–°–ª–æ–∂–Ω–æ—Å—Ç—å –ø–æ–≤—ã—Å–∏–ª–∞—Å—å!";
            } else if (state.lastResult === 'almost') {
                instructionText = "–°–µ–π—á–∞—Å –ø–æ–ª—É—á–∏—Ç—Å—è!";
            } else {
                instructionText = "–ù–∞—á–Ω—ë–º —Å–Ω–∞—á–∞–ª–∞?";
            }
            
            elements.instruction.textContent = instructionText;
            elements.instruction.classList.add('show');
            
            state.parts.forEach(p => {
                const randomIndex = Math.floor(Math.random() * state.partCounts[p]);
                state.idleCharacter[p] = getRandomOrderItem(p, randomIndex);
            });
            render(elements.characterDisplay, state.idleCharacter);
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –î–õ–Ø TELEGRAM: requestAnimationFrame –≤–º–µ—Å—Ç–æ setInterval
            let lastUpdate = 0;
            const animateIdle = (timestamp) => {
                if (!state.idleInterval) return;
                
                if (timestamp - lastUpdate >= 1000) {
                    lastUpdate = timestamp;
                    
                    const p = state.parts[Math.floor(Math.random() * state.parts.length)];
                    let next;
                    do { 
                        const randomIndex = Math.floor(Math.random() * state.partCounts[p]);
                        next = getRandomOrderItem(p, randomIndex); 
                    } while (next.id === state.idleCharacter[p].id);
                    
                    state.idleCharacter[p] = next;
                    render(elements.characterDisplay, state.idleCharacter);
                }
                
                state.idleInterval = requestAnimationFrame(animateIdle);
            };
            
            state.idleInterval = requestAnimationFrame(animateIdle);
        }

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–Ω–∏–º–∞—Ü–∏–∏ –≤ —Ä–µ–∂–∏–º–µ –æ–∂–∏–¥–∞–Ω–∏—è
        function stopIdle() { 
            if (state.idleInterval) {
                cancelAnimationFrame(state.idleInterval);
                state.idleInterval = null;
            }
        }

        // –ê–Ω–∏–º–∞—Ü–∏—è —Å–∫—Ä—ã—Ç–∏—è –∫–Ω–æ–ø–∫–∏
        function hideButtonWithAnimation(button) {
            button.style.transition = 'all 0.2s ease';
            button.style.opacity = '0';
            button.style.transform = 'scale(0.8)';
            
            setTimeout(() => {
                button.classList.add('hidden');
                button.style.transition = '';
                button.style.opacity = '';
                button.style.transform = '';
            }, 200);
        }

        // –ù–∞—á–∞–ª–æ –∏–≥—Ä—ã
        function startGame() {
            if (state.startBtnLock) return;
            
            state.startBtnLock = true;
            elements.startBtn.disabled = true;
            elements.startBtn.style.pointerEvents = 'none';
            elements.startBtn.style.cursor = 'not-allowed';
            elements.startBtn.style.opacity = '0.7';
            
            state.isBusy = true;
            state.gamePhase = 'creating';
            
            stopIdle();
            
            elements.instruction.classList.remove('show');
            setTimeout(() => {
                elements.instruction.textContent = "–°–æ–∑–¥–∞—ë–º –ø–µ—Ä—Å–æ–Ω–∞–∂–∞...";
                elements.instruction.classList.add('show');
            }, 400);
            
            hideButtonWithAnimation(elements.startBtn);
            
            // –ë—ã—Å—Ç—Ä–∞—è —Å–º–µ–Ω–∞ —á–∞—Å—Ç–µ–π –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
            let duration = 0;
            if (state.fastCycle) {
                clearInterval(state.fastCycle);
                state.fastCycle = null;
            }
            
            state.fastCycle = setInterval(() => {
                const temp = {};
                state.parts.forEach(p => {
                    const randomIndex = Math.floor(Math.random() * state.partCounts[p]);
                    temp[p] = getRandomOrderItem(p, randomIndex);
                });
                render(elements.characterDisplay, temp);
                duration += 100;
                if (duration >= 2000) {
                    clearInterval(state.fastCycle);
                    state.fastCycle = null;
                    finalizeTarget();
                }
            }, 100);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
        function getMemorizeTime() {
            if (state.streak >= 50) return 1;
            else if (state.streak >= 30) return 2;
            else if (state.streak >= 15) return 3;
            else if (state.streak >= 5) return 4;
            else return 5;
        }

        // –§–∏–∫—Å–∞—Ü–∏—è —Ü–µ–ª–µ–≤–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∏ –Ω–∞—á–∞–ª–æ —Ñ–∞–∑—ã –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
        function finalizeTarget() {
            state.gamePhase = 'memorizing';
            
            state.parts.forEach(p => {
                const randomIndex = Math.floor(Math.random() * state.partCounts[p]);
                state.target[p] = getRandomOrderItem(p, randomIndex);
            });
            render(elements.characterDisplay, state.target);
            
            setTimeout(() => {
                elements.instruction.classList.remove('show');
                setTimeout(() => {
                    elements.instruction.textContent = "–ó–∞–ø–æ–º–Ω–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞";
                    elements.instruction.classList.add('show');
                    
                    let timeLeft = getMemorizeTime();
                    elements.timer.textContent = timeLeft;
                    elements.timer.classList.add('show');
                    state.isTimerActive = true;
                    
                    const t = setInterval(() => {
                        timeLeft--;
                        elements.timer.textContent = timeLeft;
                        
                        if (timeLeft <= 0) {
                            clearInterval(t);
                            state.isTimerActive = false;
                            setTimeout(() => {
                                elements.timer.classList.remove('show');
                                startSelecting();
                            }, 300);
                        }
                    }, 1000);
                }, 400);
            }, 500);
        }

        // –ù–∞—á–∞–ª–æ —Ñ–∞–∑—ã –≤—ã–±–æ—Ä–∞ –∏–≥—Ä–æ–∫–∞
        function startSelecting() {
            if (state.gamePhase === 'selecting') return;
            
            state.gamePhase = 'selecting';
            state.currentPart = 0;
            state.selection = {};
            state.canSelect = true;

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–≤—É—é —á–∞—Å—Ç—å (–∫–æ–∂—É)
            const skinType = state.parts[0];
            state.selection[skinType] = getRandomOrderItem(skinType, 0);
            
            // –°—Ä–∞–∑—É –æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–æ–∂—É
            render(elements.characterDisplay, state.selection);
            
            elements.instruction.classList.remove('show');
            
            setTimeout(() => {
                elements.selectBtn.classList.remove('hidden');
                elements.selectBtn.classList.add('show');
                
                nextCycle();
            }, 400);

            state.isBusy = false;
        }

        // –¶–∏–∫–ª –≤—ã–±–æ—Ä–∞ —Ç–µ–∫—É—â–µ–π —á–∞—Å—Ç–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
        function nextCycle() {
            if (state.currentPart >= state.parts.length) { finish(); return; }
            
            const type = state.parts[state.currentPart];
            
            if (state.currentPart > 0) {
                state.selection[type] = getRandomOrderItem(type, 0);
            }
            
            elements.instruction.classList.remove('show');
            setTimeout(() => {
                elements.instruction.textContent = `–í—ã–±–µ—Ä–∏ ${getLabel(type)}`;
                elements.instruction.classList.add('show');
            }, 200);
            
            let baseSpeed = 1200 - (state.currentPart * 200);
            let finalSpeed = state.streak > 0 ? baseSpeed * Math.pow(0.95, state.streak) : baseSpeed;
            finalSpeed = Math.max(finalSpeed, 200);
            
            let idx = 0;
            
            if (state.interval) {
                clearInterval(state.interval);
                state.interval = null;
            }
            
            const cycle = () => {
                idx = (idx + 1) % state.partCounts[type];
                state.selection[type] = getRandomOrderItem(type, idx);
                render(elements.characterDisplay, state.selection);
            };
            
            if (state.currentPart === 0) {
                idx = -1;
            }
            
            cycle();
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –î–õ–Ø TELEGRAM: requestAnimationFrame –≤–º–µ—Å—Ç–æ setInterval
            let lastCycleTime = 0;
            const cycleAnimation = (timestamp) => {
                if (!state.interval) return;
                
                if (timestamp - lastCycleTime >= finalSpeed) {
                    lastCycleTime = timestamp;
                    cycle();
                }
                
                state.interval = requestAnimationFrame(cycleAnimation);
            };
            
            state.interval = requestAnimationFrame(cycleAnimation);
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —á–∏—Ç–∞–µ–º–æ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è —á–∞—Å—Ç–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
        function getLabel(t) { 
            return {
                skin: '—Ü–≤–µ—Ç –∫–æ–∂–∏', 
                head: '–≥–æ–ª–æ–≤—É', 
                body: '—Ç–µ–ª–æ', 
                accessory: '–∞–∫—Å–µ—Å—Å—É–∞—Ä'
            }[t]; 
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –∏–≥—Ä–æ–∫–∞
        function select() {
            if (!state.canSelect) return false;
            if (state.gamePhase !== 'selecting') return false;
            
            state.canSelect = false;
            
            if (state.interval) {
                cancelAnimationFrame(state.interval);
                state.interval = null;
            }
            
            state.currentPart++;
            
            if (state.currentPart >= state.parts.length) {
                hideButtonWithAnimation(elements.selectBtn);
                setTimeout(() => {
                    state.canSelect = true;
                    finish();
                }, 200);
            } else {
                setTimeout(() => { 
                    state.canSelect = true;
                    nextCycle(); 
                }, 150);
            }
            
            return true;
        }

        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏–≥—Ä—ã –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        function finish() {
            state.gamePhase = 'finished';
            state.isBusy = true;
            elements.instruction.classList.remove('show');
            
            if (state.interval) {
                cancelAnimationFrame(state.interval);
                state.interval = null;
            }
            
            elements.gameArea.classList.add('hidden');
            
            setTimeout(() => {
                let m = 0;
                state.parts.forEach(p => { 
                    if(state.selection[p].id === state.target[p].id) m++; 
                });
                const p = Math.round((m/4)*100);
                
                if (p === 100) {
                    state.streak++; 
                    state.lastResult = 'win';
                } else if (p < 75) {
                    state.streak = 0; 
                    state.lastResult = 'lose';
                } else {
                    state.lastResult = 'almost';
                }
                
                if (state.streak > state.maxStreak) {
                    state.maxStreak = state.streak;
                }
                
                elements.resultPercent.textContent = p + '%';
                elements.resultText.textContent = p === 100 ? "–ò–¥–µ–∞–ª—å–Ω–æ! üéâ" : 
                                                (p >= 75 ? "–ü–æ—á—Ç–∏! ü§èüèª" : "–ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑...");
                render(elements.resultTarget, state.target);
                render(elements.resultPlayer, state.selection);
                updateStats();
                elements.resultScreen.classList.add('show');
                state.startBtnLock = false;
                state.resetBtnLock = false;
                state.isBusy = false;
            }, 400);
        }

        // –°–±—Ä–æ—Å –∏–≥—Ä—ã –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ä–∞—É–Ω–¥–∞
        function reset() {
            if (state.resetBtnLock) return;
            if (state.isBusy) return;
            
            state.resetBtnLock = true;
            elements.resultAgainBtn.disabled = true;
            elements.resultAgainBtn.style.pointerEvents = 'none';
            elements.resultAgainBtn.style.cursor = 'not-allowed';
            elements.resultAgainBtn.style.opacity = '0.7';
            
            state.round++;
            
            elements.resultScreen.classList.remove('show');
            
            state.target = {};
            state.selection = {};
            state.idleCharacter = {};
            
            elements.characterDisplay.innerHTML = '';
            
            setTimeout(() => {
                elements.resultTarget.innerHTML = '';
                elements.resultPlayer.innerHTML = '';
                
                elements.startBtn.classList.remove('hidden');
                elements.startBtn.style.opacity = '1';
                elements.startBtn.style.transform = 'scale(1)';
                elements.startBtn.disabled = false;
                elements.startBtn.style.pointerEvents = 'auto';
                elements.startBtn.style.cursor = 'pointer';
                
                elements.resultAgainBtn.disabled = false;
                elements.resultAgainBtn.style.pointerEvents = 'auto';
                elements.resultAgainBtn.style.cursor = 'pointer';
                elements.resultAgainBtn.style.opacity = '1';
                
                elements.selectBtn.classList.remove('show');
                elements.selectBtn.classList.add('hidden');
                elements.selectBtn.style.opacity = '';
                elements.selectBtn.style.transform = '';
                
                elements.gameArea.classList.remove('hidden');
                
                updateStats();
                
                setTimeout(() => {
                    startIdle();
                }, 100);
            }, 400);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
        function updateStats() {
            const anim = (el, val) => {
                if (el.textContent != val) {
                    el.classList.add('updating');
                    setTimeout(() => { 
                        el.textContent = val; 
                        el.classList.remove('updating'); 
                    }, 300);
                }
            };
            anim(elements.round, state.round);
            anim(elements.streak, state.streak);
            anim(elements.maxStreak, state.maxStreak);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –ø—Ä–æ–±–µ–ª–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        window.addEventListener('keydown', e => {
            if (e.code === 'Space') {
                e.preventDefault();

                if (state.isTimerActive) return;
                if (state.isBusy) return;
                if (state.gamePhase === 'memorizing') return;
                if (state.gamePhase === 'creating') return;
                if (state.gamePhase === 'selecting' && elements.selectBtn.classList.contains('hidden')) {
                    return;
                }
                
                if (state.gamePhase === 'idle' && !state.startBtnLock && !elements.startBtn.classList.contains('hidden')) {
                    startGame();
                } else if (state.gamePhase === 'selecting' && state.canSelect) {
                    select();
                } else if (state.gamePhase === 'finished' && !state.resetBtnLock) {
                    reset();
                }
            }
        });

        // –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫
        elements.startBtn.onclick = () => startGame();
        elements.selectBtn.onclick = () => select();
        elements.resultAgainBtn.onclick = () => reset();

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = async () => {
            await loadImages();
            startIdle();
        };
    </script>
</body>
</html>
